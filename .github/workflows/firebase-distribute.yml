name: Android Release + Firebase Distribution

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  android:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: Install JS dependencies
        run: npm ci

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      # ðŸ” Decode keystore
      - name: Decode Android keystore
        run: |
          echo "${ANDROID_KEYSTORE_BASE64}" | base64 --decode > android/release.keystore
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}

      # ðŸ§± Build APK
      - name: Build Release APK
        working-directory: android
        env:
          ANDROID_KEYSTORE_PATH: ../release.keystore
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          ./gradlew clean
          ./gradlew assembleRelease

      # ðŸ”¥ Firebase CLI    

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}

     # ðŸ”¥ Firebase CLI
      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      # ðŸš€ Firebase App Distribution
      - name: Upload to Firebase App Distribution
        run: |
          firebase appdistribution:distribute \
            android/app/build/outputs/apk/release/app-release.apk \
            --app 1:898242390178:android:e6c6099b67dbd130aa4ffb \
            --groups "internal-testers" \
            --release-notes "CI build from GitHub Actions"
